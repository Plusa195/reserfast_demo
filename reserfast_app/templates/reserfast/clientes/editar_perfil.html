{% extends 'reserfast/clientes/base_cliente.html' %}
{% load static %}

{% block title %}Editar Perfil - ReserFast{% endblock %}

{% block extra_css %}
<style>
    .edit-profile-card {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    
    .section-header {
        background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1));
        border-radius: 15px;
        border: 1px solid rgba(255,255,255,0.2);
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        color: var(--text-color);
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
    }
    
    .form-control, .form-select {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 10px;
        color: var(--text-color);
        padding: 12px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        background: rgba(255,255,255,0.15);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.2rem rgba(59,130,246,0.25);
        color: var(--text-color);
    }
    
    .form-control::placeholder {
        color: rgba(255,255,255,0.6);
    }
    
    body.theme-dark .form-control::placeholder {
        color: rgba(241,245,249,0.6);
    }
    
    .current-photo {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 3px solid var(--accent-color);
        object-fit: cover;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    .photo-placeholder {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 3px solid var(--accent-color);
        background: linear-gradient(135deg, var(--accent-color), #8b5cf6);
        color: white;
        font-size: 2.5rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-save {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        border: none;
        border-radius: 10px;
        color: white;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(34,197,94,0.3);
    }
    
    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(34,197,94,0.4);
        color: white;
    }
    
    .btn-cancel {
        background: linear-gradient(135deg, #6b7280, #4b5563);
        border: none;
        border-radius: 10px;
        color: white;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(107,114,128,0.3);
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(107,114,128,0.4);
        color: white;
        text-decoration: none;
    }
    
    .error-message {
        background: rgba(239,68,68,0.1);
        border: 1px solid rgba(239,68,68,0.2);
        color: #ef4444;
        padding: 10px 15px;
        border-radius: 8px;
        margin-top: 8px;
        font-size: 0.9rem;
    }
    
    .help-text {
        color: rgba(255,255,255,0.7);
        font-size: 0.85rem;
        margin-top: 5px;
    }
    
    body.theme-dark .help-text {
        color: rgba(241,245,249,0.7);
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-8">
            <!-- Header -->
            <div class="section-header text-center">
                <h2 class="mb-2" style="color: var(--text-color); font-weight: 700;">
                    <i class="fas fa-user-edit me-2" style="color: var(--accent-color);"></i>
                    Editar Perfil
                </h2>
                <p class="text-muted mb-0">Actualiza tu información personal y configuraciones</p>
            </div>

            <!-- Formulario -->
            <div class="edit-profile-card p-4">
                <form method="post" enctype="multipart/form-data" id="editProfileForm">
                    {% csrf_token %}
                    
                    <!-- Foto de Perfil -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="mb-3" style="color: var(--text-color); font-weight: 600;">
                                <i class="fas fa-camera me-2" style="color: var(--accent-color);"></i>
                                Foto de Perfil
                            </h5>
                            
                            <div class="d-flex align-items-center gap-4">
                                <!-- Foto Actual -->
                                <div>
                                    {% if cliente.s_foto_perfil %}
                                        <img src="{{ cliente.s_foto_perfil.url }}" alt="Foto actual" class="current-photo"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="photo-placeholder" style="display: none;">
                                            {{ cliente.s_primernombrecliente|first|upper }}{{ cliente.s_primerapellidocliente|first|upper }}
                                        </div>
                                    {% else %}
                                        <div class="photo-placeholder">
                                            {{ cliente.s_primernombrecliente|first|upper }}{{ cliente.s_primerapellidocliente|first|upper }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Input de Archivo -->
                                <div class="flex-grow-1">
                                    <label for="{{ form.s_foto_perfil.id_for_label }}" class="form-label">
                                        Cambiar Foto
                                    </label>
                                    {{ form.s_foto_perfil }}
                                    <div class="help-text">
                                        Formatos permitidos: JPG, PNG, GIF. Tamaño máximo: 5MB
                                    </div>
                                    {% if form.s_foto_perfil.errors %}
                                        <div class="error-message">
                                            {{ form.s_foto_perfil.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr style="border-color: rgba(255,255,255,0.2); margin: 2rem 0;">

                    <!-- Información Personal -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="mb-3" style="color: var(--text-color); font-weight: 600;">
                                <i class="fas fa-user me-2" style="color: var(--accent-color);"></i>
                                Información Personal
                            </h5>
                        </div>
                        
                        <!-- Primer Nombre -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.s_primernombrecliente.id_for_label }}" class="form-label">
                                    Primer Nombre *
                                </label>
                                {{ form.s_primernombrecliente }}
                                {% if form.s_primernombrecliente.errors %}
                                    <div class="error-message">
                                        {{ form.s_primernombrecliente.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Segundo Nombre -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.s_segundonombrecliente.id_for_label }}" class="form-label">
                                    Segundo Nombre
                                </label>
                                {{ form.s_segundonombrecliente }}
                                {% if form.s_segundonombrecliente.errors %}
                                    <div class="error-message">
                                        {{ form.s_segundonombrecliente.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Primer Apellido -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.s_primerapellidocliente.id_for_label }}" class="form-label">
                                    Primer Apellido *
                                </label>
                                {{ form.s_primerapellidocliente }}
                                {% if form.s_primerapellidocliente.errors %}
                                    <div class="error-message">
                                        {{ form.s_primerapellidocliente.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Segundo Apellido -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.s_segundoapellidocliente.id_for_label }}" class="form-label">
                                    Segundo Apellido
                                </label>
                                {{ form.s_segundoapellidocliente }}
                                {% if form.s_segundoapellidocliente.errors %}
                                    <div class="error-message">
                                        {{ form.s_segundoapellidocliente.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- RUT -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.s_rut.id_for_label }}" class="form-label">
                                    RUT
                                </label>
                                {{ form.s_rut }}
                                {% if form.s_rut.errors %}
                                    <div class="error-message">
                                        {{ form.s_rut.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.s_email.id_for_label }}" class="form-label">
                                    Email *
                                </label>
                                {{ form.s_email }}
                                {% if form.s_email.errors %}
                                    <div class="error-message">
                                        {{ form.s_email.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Género -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.fk_id_genero.id_for_label }}" class="form-label">
                                    Género
                                </label>
                                {{ form.fk_id_genero }}
                                {% if form.fk_id_genero.errors %}
                                    <div class="error-message">
                                        {{ form.fk_id_genero.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Teléfono -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.s_telefono.id_for_label }}" class="form-label">
                                    Teléfono
                                </label>
                                {{ form.s_telefono }}
                                {% if form.s_telefono.errors %}
                                    <div class="error-message">
                                        {{ form.s_telefono.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Fecha de Nacimiento -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.d_fecha_nacimiento.id_for_label }}" class="form-label">
                                    Fecha de Nacimiento
                                </label>
                                {{ form.d_fecha_nacimiento }}
                                {% if form.d_fecha_nacimiento.errors %}
                                    <div class="error-message">
                                        {{ form.d_fecha_nacimiento.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <hr style="border-color: rgba(255,255,255,0.2); margin: 2rem 0;">

                    <!-- Cambiar Contraseña -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="mb-3" style="color: var(--text-color); font-weight: 600;">
                                <i class="fas fa-key me-2" style="color: var(--accent-color);"></i>
                                Cambiar Contraseña (Opcional)
                            </h5>
                        </div>

                        <!-- Contraseña Actual -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.contrasena_actual.id_for_label }}" class="form-label">
                                    Contraseña Actual
                                </label>
                                {{ form.contrasena_actual }}
                                <div class="help-text">
                                    Requerida solo si deseas cambiar tu contraseña
                                </div>
                                {% if form.contrasena_actual.errors %}
                                    <div class="error-message">
                                        {{ form.contrasena_actual.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Nueva Contraseña -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.nueva_contrasena.id_for_label }}" class="form-label">
                                    Nueva Contraseña
                                </label>
                                {{ form.nueva_contrasena }}
                                <div class="help-text">
                                    Mínimo 6 caracteres
                                </div>
                                {% if form.nueva_contrasena.errors %}
                                    <div class="error-message">
                                        {{ form.nueva_contrasena.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Confirmar Contraseña -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.confirmar_contrasena.id_for_label }}" class="form-label">
                                    Confirmar Nueva Contraseña
                                </label>
                                {{ form.confirmar_contrasena }}
                                {% if form.confirmar_contrasena.errors %}
                                    <div class="error-message">
                                        {{ form.confirmar_contrasena.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Errores Generales -->
                    {% if form.non_field_errors %}
                        <div class="error-message mb-3">
                            {{ form.non_field_errors.0 }}
                        </div>
                    {% endif %}

                    <!-- Botones -->
                    <div class="d-flex justify-content-between align-items-center pt-3">
                        <a href="{% url 'reserfast:perfil_cliente' %}" class="btn-cancel">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        
                        <button type="submit" class="btn-save">
                            <i class="fas fa-save me-2"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Preview de imagen
        const fotoInput = document.querySelector('input[name="s_foto_perfil"]');
        const currentPhoto = document.querySelector('.current-photo');
        const photoPlaceholder = document.querySelector('.photo-placeholder');
        
        if (fotoInput) {
            fotoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (currentPhoto) {
                            currentPhoto.src = e.target.result;
                            currentPhoto.style.display = 'block';
                            if (photoPlaceholder) {
                                photoPlaceholder.style.display = 'none';
                            }
                        } else if (photoPlaceholder) {
                            // Crear imagen temporal para preview
                            const tempImg = document.createElement('img');
                            tempImg.src = e.target.result;
                            tempImg.className = 'current-photo';
                            photoPlaceholder.style.display = 'none';
                            photoPlaceholder.parentNode.insertBefore(tempImg, photoPlaceholder);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Validación en tiempo real
        const form = document.getElementById('editProfileForm');
        const inputs = form.querySelectorAll('input[required]');
        
        inputs.forEach(input => {
            input.addEventListener('blur', function() {
                if (this.value.trim() === '') {
                    this.style.borderColor = '#ef4444';
                } else {
                    this.style.borderColor = 'rgba(255,255,255,0.2)';
                }
            });
        });
        
        // Confirmación antes de salir si hay cambios
        let formChanged = false;
        const formInputs = form.querySelectorAll('input, select, textarea');
        
        formInputs.forEach(input => {
            input.addEventListener('change', function() {
                formChanged = true;
            });
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (formChanged) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        
        // Resetear flag al enviar formulario
        form.addEventListener('submit', function() {
            formChanged = false;
        });
    });
</script>
{% endblock %}
